# 代理拦截器使用说明

## 🎉 好消息！代理修复已固化到代码中

现在您不再需要每次手动执行代理修复代码了！我已经将增强版代理拦截器集成到应用中，它会在应用启动时自动激活。

## 🔧 自动激活条件

代理拦截器会在以下条件下自动启用：

1. **启用自定义API配置**：在设置中开启 `useCustomApiConfig`
2. **设置代理URL**：在设置中配置 `apiProxyUrl`（例如：`https://api-proxy.me/gemini`）
3. **应用启动**：每次打开或刷新页面时自动检查并启用

## 📋 使用步骤

### 方法一：通过设置界面（推荐）

1. **打开设置**
   - 点击页面右上角的设置按钮
   - 或按快捷键打开设置

2. **配置API设置**
   - 启用"使用自定义API配置"
   - 设置API Key：`AIzaSyCUduSy8NLnF0hKWjgial1Qtm8YQ6-LKr0`
   - 设置代理URL：`https://api-proxy.me/gemini`

3. **保存设置**
   - 点击保存按钮
   - 刷新页面（F5）

### 方法二：直接修改localStorage（高级用户）

如果您熟悉浏览器开发工具，可以直接设置：

```javascript
localStorage.setItem('app-settings', JSON.stringify({
    useCustomApiConfig: true,
    apiProxyUrl: 'https://api-proxy.me/gemini',
    apiKey: 'AIzaSyCUduSy8NLnF0hKWjgial1Qtm8YQ6-LKr0',
    // ... 其他设置
}));
```

然后刷新页面。

## ✅ 验证代理是否生效

1. **打开开发者工具**（F12）
2. **查看控制台**，应该看到：
   ```
   ✅ [ProxyInterceptor] 自动启用代理拦截器: https://api-proxy.me/gemini/v1beta
   🔧 [ProxyInterceptor] 增强版代理拦截器已启用
   ```

3. **查看网络请求**：
   - 切换到 Network 标签页
   - 发送消息或加载模型
   - 确认请求发送到 `api-proxy.me` 而不是 `generativelanguage.googleapis.com`

4. **查看代理日志**：
   ```
   🔄 [ProxyInterceptor] 代理请求: https://generativelanguage.googleapis.com/... -> https://api-proxy.me/gemini/...
   ```

## 🔍 技术细节

### 拦截的请求类型

增强版拦截器会自动拦截以下所有类型的网络请求：

- ✅ **fetch()** 请求
- ✅ **XMLHttpRequest** 请求
- ✅ **EventSource** 请求（SSE流式请求）
- ✅ **WebSocket** 连接
- ✅ **navigator.sendBeacon** 请求

### 代码位置

- **拦截器模块**：`utils/proxyInterceptor.ts`
- **初始化位置**：`index.tsx`
- **自动启用逻辑**：应用启动时检查localStorage设置

### 配置文件

拦截器会自动读取以下localStorage配置：
- `useCustomApiConfig`: 是否启用自定义API配置
- `apiProxyUrl`: 代理服务器URL
- `apiKey`: API密钥

## 🛠️ 故障排除

### 问题1：代理未自动启用

**检查步骤**：
1. 确认设置中已启用"使用自定义API配置"
2. 确认已设置代理URL
3. 刷新页面（F5）
4. 查看控制台是否有启用日志

### 问题2：仍然出现地理位置错误

**解决方案**：
1. 清除浏览器缓存
2. 完全关闭浏览器重新打开
3. 检查代理服务器是否可访问

### 问题3：控制台没有代理日志

**可能原因**：
- localStorage设置不正确
- 代理URL格式错误
- 浏览器兼容性问题

## 🎯 优势

相比手动执行代码，固化版本具有以下优势：

1. **自动化**：无需每次手动执行
2. **持久化**：设置保存后永久生效
3. **稳定性**：集成到应用代码中，更稳定可靠
4. **用户友好**：通过设置界面管理，无需技术知识
5. **完整覆盖**：拦截所有类型的网络请求

## 📞 需要帮助？

如果遇到问题：
1. 检查控制台日志
2. 确认网络请求是否走代理
3. 尝试清除缓存重新设置

现在您可以正常使用All-Model-Chat，无需担心地理位置限制问题！