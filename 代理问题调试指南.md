# All-Model-Chat 代理问题调试指南

## 问题现象
设置了 `https://api-proxy.me/gemini` 代理 URL 和 API Key 后，仍然显示：
```
API model fetch failed: {"error":{"code":400,"message":"User location is not supported for the API use.","status":"FAILED_PRECONDITION"}}. Using fallbacks.
```

这个错误表明请求仍然直接发送到了 Google 的 API，而不是通过代理。

## 根本原因分析
1. **Service Worker 未正确拦截请求**
2. **代理 URL 配置未正确传递到 Service Worker**
3. **GoogleGenAI SDK 的直接调用绕过了代理**

## 修复方案

### 1. 立即测试步骤

#### 步骤 1: 加载调试工具
1. 打开项目页面（如果还没启动，先运行 `npm run dev`）
2. 按 F12 打开开发者工具
3. 在 Console 中运行：
```javascript
// 加载调试工具
fetch('./debug-proxy.js').then(r=>r.text()).then(eval);
```

#### 步骤 2: 运行完整诊断
```javascript
// 替换为您的实际 API Key
ProxyDebugger.runFullDiagnosis("your-gemini-api-key-here");
```

#### 步骤 3: 检查诊断结果
观察控制台输出，特别注意：
- Service Worker 是否已激活
- 代理 URL 是否正确设置
- API 测试是否通过

### 2. 手动验证步骤

#### 检查 Service Worker 状态
```javascript
// 检查 SW 状态
console.log('SW Controller:', navigator.serviceWorker.controller);
console.log('SW Ready:', await navigator.serviceWorker.ready);
```

#### 检查代理配置
```javascript
// 检查 localStorage 中的配置
const settings = JSON.parse(localStorage.getItem('app-settings') || '{}');
console.log('使用自定义配置:', settings.useCustomApiConfig);
console.log('代理 URL:', settings.apiProxyUrl);
console.log('API Key:', settings.apiKey ? '已设置' : '未设置');
```

#### 手动发送代理 URL 到 Service Worker
```javascript
// 确保 SW 收到代理 URL
if (navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({
        type: 'SET_PROXY_URL',
        url: 'https://api-proxy.me/gemini'
    });
    console.log('代理 URL 已发送到 Service Worker');
}
```

### 3. 网络请求监控

#### 在 Network 面板中检查
1. 打开开发者工具的 Network 面板
2. 清除现有请求
3. 在应用中触发 API 调用（如加载模型列表）
4. 查看请求的目标 URL：
   - ✅ 正确：请求发送到 `https://api-proxy.me/gemini/...`
   - ❌ 错误：请求发送到 `https://generativelanguage.googleapis.com/...`

#### 使用 Console 监控
```javascript
// 监控所有 fetch 请求
const originalFetch = window.fetch;
window.fetch = function(...args) {
    const url = args[0];
    if (typeof url === 'string' && url.includes('generativelanguage')) {
        console.log('🔍 API 请求:', url);
        console.log('🚨 警告：请求未通过代理！');
    }
    return originalFetch.apply(this, args);
};
```

### 4. Service Worker 调试

#### 查看 Service Worker 控制台
1. 在开发者工具中切换到 Application 面板
2. 点击左侧的 Service Workers
3. 找到当前的 Service Worker
4. 点击 "inspect" 打开 SW 的控制台
5. 查看是否有相关的日志输出

#### 强制更新 Service Worker
```javascript
// 强制更新 Service Worker
navigator.serviceWorker.getRegistrations().then(registrations => {
    registrations.forEach(registration => {
        registration.update();
    });
});

// 或者完全重新注册
navigator.serviceWorker.getRegistrations().then(registrations => {
    registrations.forEach(registration => {
        registration.unregister();
    });
}).then(() => {
    window.location.reload();
});
```

### 5. 常见问题和解决方案

#### 问题 1: Service Worker 未激活
**解决方案：**
```javascript
// 手动注册 Service Worker
navigator.serviceWorker.register('./sw.js')
    .then(() => navigator.serviceWorker.ready)
    .then(() => {
        console.log('Service Worker 已就绪');
        window.location.reload();
    });
```

#### 问题 2: 代理 URL 未传递到 Service Worker
**解决方案：**
```javascript
// 确保在 SW 就绪后发送代理 URL
navigator.serviceWorker.ready.then(() => {
    navigator.serviceWorker.controller.postMessage({
        type: 'SET_PROXY_URL',
        url: 'https://api-proxy.me/gemini'
    });
});
```

#### 问题 3: 缓存问题
**解决方案：**
1. 清除浏览器缓存
2. 硬刷新页面 (Ctrl+Shift+R)
3. 清除 localStorage：
```javascript
localStorage.clear();
```

### 6. 验证修复是否成功

#### 成功指标
1. ✅ Service Worker 控制台显示：`[SW] Proxy URL set to: https://api-proxy.me/gemini`
2. ✅ Network 面板显示请求发送到代理 URL
3. ✅ 不再出现 "User location is not supported" 错误
4. ✅ 能够正常加载模型列表
5. ✅ 聊天功能正常工作

#### 最终测试
```javascript
// 最终验证脚本
async function finalTest() {
    // 1. 检查配置
    const settings = JSON.parse(localStorage.getItem('app-settings') || '{}');
    console.log('配置检查:', {
        useCustomApi: settings.useCustomApiConfig,
        proxyUrl: settings.apiProxyUrl,
        hasApiKey: !!settings.apiKey
    });
    
    // 2. 检查 Service Worker
    const swActive = !!navigator.serviceWorker.controller;
    console.log('Service Worker 激活:', swActive);
    
    // 3. 发送测试消息到 SW
    if (swActive) {
        navigator.serviceWorker.controller.postMessage({
            type: 'SET_PROXY_URL',
            url: settings.apiProxyUrl
        });
    }
    
    // 4. 等待并测试
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    console.log('✅ 配置完成，请尝试在应用中发送消息测试');
}

finalTest();
```

## 联系支持

如果按照以上步骤仍然无法解决问题，请提供：

1. **浏览器控制台的完整输出**
2. **Service Worker 控制台的日志**
3. **Network 面板中 API 请求的截图**
4. **使用的浏览器和版本**
5. **代理服务的响应状态**

这些信息将帮助进一步诊断问题。